<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Staff Cancellation Requests | Zero Degree Café</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<style>
  .sidebar {
    height: 100vh; position: fixed; top: 0; left: 0; width: 250px;
    background: linear-gradient(145deg, #1d3c5a, #3a5f7d); color: white; padding-top: 30px;
    overflow-y: auto; box-shadow: 4px 0px 10px rgba(0, 0, 0, 0.1);
  }
  .sidebar h3 { text-align: center; font-size: 30px; font-weight: bold; margin-bottom: 30px; }
  .sidebar a { color: white; text-decoration: none; padding: 12px 20px; display: block;
    border-radius: 25px; font-size: 18px; margin: 10px 0; transition: all 0.3s ease; }
  .sidebar a:hover { background-color: #f1f1f1; color: #1d3c5a; transform: translateX(10px); }
  .sidebar a.active { background-color: #3a5f7d; color: white; }
  .sidebar .logout a { width: 150px; text-align: center; margin-top: 30px; font-size: 16px; }
  .sidebar .logout a:hover { background-color: #e74c3c; }
  .content { margin-left: 270px; padding: 20px; }
  .product-img { width: 35px; height: 35px; object-fit: cover; border-radius: 5px; margin-right: 5px; }
</style>
</head>
<body>

<div class="sidebar d-flex flex-column">
  <div class="d-flex justify-content-center mb-3">
    <img src="/images/zicon.jpg" style="width: 75px;" class="rounded-circle" alt="">
  </div>
  <h3 class="text-white mb-5">Staff Panel</h3>
  <a href="/staff/index"><i class="bi bi-house-door"></i> Dashboard</a>
  <a href="/staff/orders"><i class="bi bi-file-earmark-text"></i> Orders</a>
  <a href="/staff/void" class="active"><i class="bi bi-x-circle"></i> Cancellation Requests</a>
  <div class="logout d-flex justify-content-center mt-auto mb-3">
    <a href="/logout" class="btn btn-danger" style="width: 150px;">
      <i class="bi bi-box-arrow-right"></i> Logout
    </a>
  </div>
</div>

<div class="content">
  <h2 class="mb-4">Pending Cancellation Requests</h2>
  <table class="table table-bordered table-hover">
    <thead>
      <tr>
        <th>Order ID</th>
        <th>User</th>
        <th>Items</th>
        <th>Total (₱)</th>
        <th>Requested At</th>
        <th>Reason</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% if(cancellations.length > 0){ %>
        <% cancellations.forEach(order => { %>
          <tr>
            <td><%= order._id %></td>
            <td><%= order.userInfoSnapshot?.firstName || 'N/A' %> <%= order.userInfoSnapshot?.lastName || '' %></td>
            <td>
              <ul class="list-unstyled mb-0">
                <% order.items.forEach(item => { %>
                  <li class="d-flex align-items-center mb-1">
                    <img src="<%= item.productId?.productImage || '/images/no-image.jpg' %>" class="product-img">
                    <span><%= item.productId?.productName || 'Unknown' %> x <%= item.quantity %></span>
                  </li>
                <% }) %>
              </ul>
            </td>
            <td><%= order.netTotal.toFixed(2) %></td>
            <td><%= new Date(order.cancellationRequestedAt).toLocaleString() %></td>
            <td><%= order.cancellationReason && order.cancellationReason.trim() !== '' ? order.cancellationReason : 'Processing' %></td>
            <td>
              <button class="btn btn-success btn-sm mb-1 btn-approve" data-id="<%= order._id %>">Approve</button>
              <button class="btn btn-danger btn-sm btn-reject" data-id="<%= order._id %>">Reject</button>
            </td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr>
          <td colspan="7" class="text-center">No pending cancellation requests.</td>
        </tr>
      <% } %>
    </tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

  // Approve
  document.querySelectorAll('.btn-approve').forEach(btn => {
    btn.addEventListener('click', async () => {
      const orderId = btn.dataset.id;
      const result = await Swal.fire({
        title: 'Approve Cancellation?',
        text: "This will approve the user's cancellation request and restore stock.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#198754',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, approve it!',
      });
      if (result.isConfirmed) {
        try {
          const res = await fetch(`/staff/cancellations/${orderId}/approve`, { method: 'POST' });
          const data = await res.json();
          if (res.ok) {
            Swal.fire({ icon: 'success', title: 'Approved', text: data.message }).then(() => location.reload());
          } else {
            Swal.fire({ icon: 'error', title: 'Error', text: data.message || 'Failed to approve' });
          }
        } catch (err) {
          Swal.fire({ icon: 'error', title: 'Server Error', text: 'Failed to approve cancellation' });
        }
      }
    });
  });

  // Reject
  document.querySelectorAll('.btn-reject').forEach(btn => {
    btn.addEventListener('click', async () => {
      const orderId = btn.dataset.id;
      const result = await Swal.fire({
        title: 'Reject Cancellation?',
        text: "This will reject the user's cancellation request.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, reject it!',
      });
      if (result.isConfirmed) {
        try {
          const res = await fetch(`/staff/cancellations/${orderId}/reject-proof`, { method: 'POST' });
          const data = await res.json();
          if (res.ok) {
            Swal.fire({ icon: 'success', title: 'Rejected', text: data.message }).then(() => location.reload());
          } else {
            Swal.fire({ icon: 'error', title: 'Error', text: data.message || 'Failed to reject' });
          }
        } catch (err) {
          Swal.fire({ icon: 'error', title: 'Server Error', text: 'Failed to reject cancellation' });
        }
      }
    });
  });

});
</script>

</body>
</html>
