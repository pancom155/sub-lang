<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout | Zero Degree Café</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.12.1/font/bootstrap-icons.min.css" rel="stylesheet">
<style>
  body {
    background-color: #f1f1f1;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  .navbar-custom {
    background: linear-gradient(145deg, #1d3c5a, #3a5f7d);
  }
  .navbar-custom .navbar-brand { color: #fff; font-weight: 700; }
  .navbar-custom .nav-link { color: #fff; font-weight: 600; }
  h2 { color: #1d3c5a; margin-bottom: 30px; }
  .product-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
  .product-card { background-color: #fff; border-radius: 15px; box-shadow: 0 6px 15px rgba(0,0,0,0.08); text-align: center; padding: 10px; }
  .product-card img { width: 100%; height: 120px; object-fit: cover; border-radius: 12px; margin-bottom: 10px; }
  .form-label { font-weight: 600; color: #1d3c5a; }
  .form-control, .form-select { border-radius: 10px; border: 1px solid #ccc; }
  .btn-primary { background: linear-gradient(145deg, #1d3c5a, #3a5f7d); border: none; font-weight: 600; }
  .bg-gradient-primary { background: linear-gradient(145deg, #1d3c5a, #3a5f7d); }
  .modal-content { overflow: hidden; }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-custom mb-4">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center" href="#">
      <img src="/images/zicon.jpg" alt="Logo" class="rounded-circle" style="width: 40px; height: 40px; margin-right: 10px;">
      Zero Degree Café
    </a>
    <button class="navbar-toggler border border-light" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon" style="filter: invert(1);"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link" href="/cart"><i class="bi bi-arrow-left-circle me-1"></i>Back to Cart</a></li>
        <li class="nav-item"><a class="nav-link" href="/dashboard"><i class="bi bi-house-door me-1"></i>Back to Dashboard</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container mb-5">
  <h2 class="text-center mb-4"><i class="bi bi-bag-check me-2"></i>Checkout</h2>

  <form id="checkoutForm" action="/cart/checkout" method="POST" enctype="multipart/form-data">
    <div class="row g-3">
      <div class="col-md-8">
        <h5 class="mb-3"><i class="bi bi-cart3 me-2"></i>Cart Items</h5>
        <div class="product-grid">
          <% cartItems.forEach(item => { %>
            <div class="product-card">
              <img src="<%= item.product_id.productImage || '/images/default.jpg' %>" alt="<%= item.product_id.productName %>">
              <strong><i class="bi bi-cup-hot me-1"></i><%= item.product_id.productName %></strong>
              <span>x <%= item.quantity %></span>
              <span>₱<%= (item.product_id.price * item.quantity).toFixed(2) %></span>
            </div>
          <% }) %>
        </div>
      </div>

      <div class="col-md-4 mt-5">
        <h5 class="mb-3 text-primary"><i class="bi bi-receipt me-2"></i>Order Details</h5>
        <div class="mb-3">
          <label for="noteToCashier" class="form-label"><i class="bi bi-pencil-square"></i>Note to Cashier (Optional)</label>
          <textarea class="form-control" name="noteToCashier" id="noteToCashier" rows="3" placeholder="Add instructions if needed..."></textarea>
        </div>

        <div class="mb-3">
          <label for="paymentMode" class="form-label"><i class="bi bi-cash-stack"></i>Payment Mode</label>
          <select name="paymentMode" id="paymentMode" class="form-select" required>
            <option value="" disabled selected>Select Payment Mode</option>
            <option value="COD">Cash On Delivery</option>
            <option value="Pickup">Pickup</option>
            <option value="GCash">GCash</option>
          </select>
        </div>

        <button type="button" class="btn btn-primary w-100 mt-2" id="openModalBtn">
          <i class="bi bi-credit-card-2-front me-2"></i>Place Order
        </button>
      </div>
    </div>
  </form>
</div>

<!-- Modal Step 1 -->
<div class="modal fade" id="modalStep1" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg border-0 rounded-4">
      <div class="modal-header bg-gradient-primary text-white rounded-top-4">
        <h5 class="modal-title"><i class="bi bi-qr-code-scan me-2"></i>Step 1: Scan QR</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center py-4">
        <img id="qrImage" src="" class="img-fluid rounded-3 shadow-sm mb-3" alt="QR Code">
        <p id="paymentText" class="fw-semibold"></p>
      </div>
      <div class="modal-footer border-0 justify-content-center">
        <button type="button" class="btn btn-primary btn-lg px-4" id="nextModalBtn">
          <i class="bi bi-arrow-right-circle me-2"></i>Next
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Step 2 -->
<div class="modal fade" id="modalStep2" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg border-0 rounded-4">
      <div class="modal-header bg-gradient-primary text-white rounded-top-4">
        <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Step 2: Payment Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body py-4">
        <div class="mb-3">
          <label class="form-label"><i class="bi bi-person-circle me-1"></i>Sender Name</label>
          <input type="text" class="form-control" name="senderName" placeholder="Enter your name" required>
        </div>
        <div class="mb-3">
          <label class="form-label"><i class="bi bi-credit-card-2-front me-1"></i>Reference Number</label>
          <input type="number" class="form-control" name="referenceNumber" placeholder="Enter reference number" required>
        </div>
        <div class="mb-3">
          <label class="form-label"><i class="bi bi-image me-1"></i>Upload Proof</label>
          <input type="file" class="form-control" name="proofImage" accept="image/*" required>
        </div>
      </div>
      <div class="modal-footer border-0 justify-content-center">
        <button type="button" class="btn btn-primary btn-lg px-4" id="submitModalBtn">
          <i class="bi bi-check-circle me-2"></i>Submit
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const paymentSelect = document.getElementById('paymentMode');
const qrImage = document.getElementById('qrImage');
const paymentText = document.getElementById('paymentText');
const nextModalBtn = document.getElementById('nextModalBtn');
const openModalBtn = document.getElementById('openModalBtn');
const submitModalBtn = document.getElementById('submitModalBtn');
const checkoutForm = document.getElementById('checkoutForm');

const modalStep1 = new bootstrap.Modal(document.getElementById('modalStep1'));
const modalStep2 = new bootstrap.Modal(document.getElementById('modalStep2'));

// Open modal automatically on dropdown change for GCash/Pickup
paymentSelect.addEventListener('change', function() {
  const mode = this.value;
  if (mode === 'GCash' || mode === 'Pickup') {
    qrImage.src = mode === 'GCash' ? '/images/gcash-qr.png' : '/images/pickup.png';
    paymentText.textContent = mode === 'GCash'
      ? 'Scan this QR code using your GCash app.'
      : 'Pickup instructions: Please provide your details.';
    modalStep1.show();
  }
});

// Step 1 → Step 2
nextModalBtn.addEventListener('click', () => {
  modalStep1.hide();
  modalStep2.show();
});

// Submit for GCash/Pickup
submitModalBtn.addEventListener('click', async () => {
  try {
    const formData = new FormData(checkoutForm);
    const senderName = modalStep2._element.querySelector('input[name="senderName"]').value;
    const referenceNumber = modalStep2._element.querySelector('input[name="referenceNumber"]').value;
    const proofFile = modalStep2._element.querySelector('input[name="proofImage"]').files[0];

    if (!senderName || !referenceNumber || !proofFile) {
      Swal.fire({ icon: 'error', title: 'Error', text: 'All payment fields are required!' });
      return;
    }

    formData.set('senderName', senderName);
    formData.set('referenceNumber', referenceNumber);
    formData.set('proofImage', proofFile);

    const res = await fetch('/cart/checkout', { method: 'POST', body: formData });
    const data = await res.json();

    if (data.error) throw new Error(data.error);

    Swal.fire({
      icon: 'success',
      title: 'Order Placed!',
      text: 'Your checkout was successful.',
      confirmButtonText: 'OK',
      allowOutsideClick: false
    }).then(() => window.location.href = data.redirectUrl || '/order-success');

  } catch (err) {
    console.error(err);
    Swal.fire({ icon: 'error', title: 'Error', text: err.message || 'Something went wrong!' });
  }
});

// COD → SweetAlert before submitting
openModalBtn.addEventListener('click', (e) => {
  const mode = paymentSelect.value;
  if (!mode) {
    alert('Please select a payment mode first.');
    return;
  }

  if (mode === 'COD') {
    e.preventDefault();
    Swal.fire({
      title: 'Confirm Order',
      text: "You chose Cash On Delivery. Proceed?",
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Yes, Place Order',
      cancelButtonText: 'Cancel'
    }).then((result) => {
      if (result.isConfirmed) {
        checkoutForm.submit();
      }
    });
  } else if (mode === 'GCash' || mode === 'Pickup') {
    // trigger modals automatically
    modalStep1.show();
  }
});
</script>
</body>
</html>
