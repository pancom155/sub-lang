<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spoilage | Zero Degree Café</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .sidebar {
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      width: 250px;
      background: linear-gradient(145deg, #1d3c5a, #3a5f7d);
      color: white;
      padding-top: 30px;
      overflow-y: auto;
      box-shadow: 4px 0px 10px rgba(0, 0, 0, 0.1);
    }
    .sidebar h3 { text-align: center; font-size: 30px; font-weight: bold; margin-bottom: 30px; }
    .sidebar a { color: white; text-decoration: none; padding: 12px 18px; display: block; border-radius: 25px; font-size: 16px; margin: 10px 0; transition: all 0.3s ease; }
    .sidebar a:hover { background-color: #f1f1f1; color: #1d3c5a; transform: translateX(10px); }
    .sidebar a.active { background-color: #3a5f7d; color: white; }
    .sidebar .logout { position: absolute; bottom: 20px; width: 100%; text-align: center; }
    .content { margin-left: 270px; padding: 25px; background-color: #f8f9fa; min-height: 100vh; }
    .card-custom { border-radius: 18px; border: none; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
    .lost-income-header { font-size: 1.2rem; font-weight: 600; color: #b02a37; }
    .lost-income-total { font-size: 1.3rem; font-weight: bold; color: #dc3545; }
    pre.debug { max-height: 200px; overflow: auto; background: #f7f7f7; padding: 10px; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="d-flex justify-content-center mb-3">
      <img src="/images/zicon.jpg" style="width: 70px;" class="rounded-circle" alt="">
    </div>
    <h3 class="text-center text-white fw-bold">Admin Panel</h3>
    <a href="/admin/index"><i class="bi bi-house-door"></i> Dashboard</a>
    <a href="/admin/sales"><i class="bi bi-bar-chart"></i> Sales Overview</a>
    <a href="/admin/users"><i class="bi bi-person"></i> Users</a>
    <a href="/admin/products"><i class="bi bi-box"></i> Inventory</a>
    <a href="/admin/productMonitoring"><i class="bi bi-display"></i> Product Monitoring</a>
    <a href="/admin/orders"><i class="bi bi-file-earmark-text"></i> Orders</a>
    <a href="/admin/staff"><i class="bi bi-person-badge"></i> Staff</a>
    <a href="/admin/spoilage" class="active"><i class="bi bi-trash"></i> Spoilage</a>
    <a href="/admin/reviews"><i class="bi bi-star"></i> Reviews</a>
    <div class="logout">
      <a href="/logout" style="width: 150px;" class="btn btn-danger btn-sm mx-auto"><i class="bi bi-box-arrow-right"></i> Logout</a>
    </div>
  </div>

  <div class="content">
    <div class="container">

      <!-- Warning / Error message if controller passed one -->
      <% if (typeof errorMessage !== 'undefined') { %>
        <div class="alert alert-warning text-center mb-3">
          <%= errorMessage %>
        </div>
      <% } %>

      <div class="row mb-4 justify-content-center">
        <div class="col-md-3">
          <div class="card card-custom text-center p-3">
            <h6 class="text-muted">Total Lost Income</h6>
            <h4 class="fw-bold text-danger">₱<%= Number((kpis && kpis.totalLostIncome) || 0).toFixed(2) %></h4>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card card-custom text-center p-3">
            <h6 class="text-muted">Most Wasted Product</h6>
            <h5 class="fw-bold text-secondary"><%= (kpis && kpis.mostWasted) || '-' %></h5>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card card-custom text-center p-3">
            <h6 class="text-muted">% of Sales Lost</h6>
            <h4 class="fw-bold text-warning"><%= Number((kpis && kpis.salesLostPercent) || 0).toFixed(1) %>%</h4>
          </div>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-lg-4">
          <div class="card card-custom p-3">
            <h6 class="lost-income-header mb-3 text-center">Lost Income by Product</h6>
            <ul class="list-unstyled small" style="max-height: 250px; overflow-y: auto;">
              <% (products || []).sort((a, b) => (Number(b.lostIncome || 0) - Number(a.lostIncome || 0))).forEach(p => { %>
                <li>
                  <%= (p.productName || p.name || p.title || 'Unnamed Product') %>:
                  <span class="fw-bold text-danger">₱<%= Number(p.lostIncome || 0).toFixed(2) %></span>
                </li>
              <% }) %>
              <% if (!products || products.length === 0) { %>
                <li class="text-muted">No products to display.</li>
              <% } %>
            </ul>
            <div class="lost-income-total text-center mt-3">Total: ₱<%= Number((kpis && kpis.totalLostIncome) || 0).toFixed(2) %></div>
          </div>
        </div>

        <div class="col-lg-8">
          <div class="card card-custom p-3">
            <h6 class="lost-income-header mb-3 text-center">
              <i class="bi bi-currency-dollar"></i> Lost Income Distribution
            </h6>
            <canvas id="lostIncomeDonutChart" style="max-height: 350px;"></canvas>
          </div>
        </div>
      </div>

      <div class="card card-custom p-3 mt-4">
        <h6 class="lost-income-header mb-3 text-center">
          <i class="bi bi-pie-chart"></i> Spoilage by Category
        </h6>
        <canvas id="categoryBreakdownChart" style="max-height: 300px;"></canvas>
      </div>

      <!-- Optional debug section (visible when `debugPayload` is passed) -->
      <% if (typeof debugPayload !== 'undefined' && debugPayload) { %>
        <div class="mt-4">
          <h6>Debug Payload (server side)</h6>
          <pre class="debug"><%= JSON.stringify({ products: products || [], kpis: kpis || {} }, null, 2) %></pre>
        </div>
      <% } %>

    </div>
  </div>

  <script>
    // safe injection
    const products = <%- JSON.stringify(products || []) %>;
    const categoryTotals = <%- JSON.stringify((kpis && kpis.categoryTotals) || {}) %>;

    // DONUT: Lost Income Distribution
    const ctxDonut = document.getElementById('lostIncomeDonutChart')?.getContext('2d');
    if (ctxDonut) {
      new Chart(ctxDonut, {
        type: 'doughnut',
        data: {
          labels: products.map(p => (p.productName || p.name || p.title || 'Unnamed')),
          datasets: [{
            data: products.map(p => Number(p.lostIncome || 0)),
            backgroundColor: ['#dc3545','#e4606d','#ee848a','#f5a2a8','#fabcc2','#fcd8d9','#ffebee'],
            borderColor: '#fff',
            borderWidth: 2,
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const v = context.parsed || 0;
                  return '₱' + Number(v).toFixed(2);
                }
              }
            }
          }
        }
      });
    }

    // PIE: Category breakdown
    const ctxCategory = document.getElementById('categoryBreakdownChart')?.getContext('2d');
    if (ctxCategory) {
      new Chart(ctxCategory, {
        type: 'pie',
        data: {
          labels: Object.keys(categoryTotals),
          datasets: [{
            data: Object.values(categoryTotals).map(v => Number(v || 0)),
            backgroundColor: ['#f94144','#f3722c','#f9c74f','#90be6d','#577590'],
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }
  </script>
</body>
</html>
